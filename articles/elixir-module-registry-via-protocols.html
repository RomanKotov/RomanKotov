<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <meta property="og:title" prefix="og: http://ogp.me/ns#" content="Elixir module registry via Protocols"><meta property="twitter:title" prefix="og: http://ogp.me/ns#" content="Elixir module registry via Protocols"><meta property="twitter:card" prefix="og: http://ogp.me/ns#" content="summary_large_image"><meta property="twitter:creator" prefix="og: http://ogp.me/ns#" content="@kotovr"><meta property="og:type" prefix="og: http://ogp.me/ns#" content="article"><meta property="og:url" prefix="og: http://ogp.me/ns#" content="https://romankotov.com/articles/elixir-module-registry-via-protocols.html"><meta property="og:description" prefix="og: http://ogp.me/ns#" content="Personal blog"><meta property="og:image" prefix="og: http://ogp.me/ns#" content="https://romankotov.com/assets/favicon_io/android-chrome-512x512.png"><meta property="twitter:image" prefix="og: http://ogp.me/ns#" content="https://romankotov.com/assets/favicon_io/android-chrome-512x512.png"><meta property="og:article:author" prefix="og: http://ogp.me/ns#" content="Roman Kotov"><script type="application/ld+json">{"author":{"@type":"Person","name":"Roman Kotov"},"description":"Personal blog","headline":"Elixir module registry via Protocols","url":"https://romankotov.com/articles/elixir-module-registry-via-protocols.html","@type":"article","@context":"https://schema.org"}</script><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/favicon_io/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon_io/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon_io/favicon-16x16.png"><link rel="shortcut icon" type="image/x-icon" href="/assets/favicon_io/favicon.ico"><link rel="manifest" href="/assets/favicon_io/site.webmanifest"><meta name="theme-color" content="#3eaf7c"><title>Elixir module registry via Protocols | Roman Kotov's blog</title><meta name="description" content="Personal blog">
    <link rel="modulepreload" href="/assets/app.f80e3e6e.js"><link rel="modulepreload" href="/assets/elixir-module-registry-via-protocols.html.9457d082.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.5a098b48.js"><link rel="modulepreload" href="/assets/elixir-module-registry-via-protocols.html.48cb3191.js">
    <link rel="stylesheet" href="/assets/style.d7da4c20.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container" data-v-50d8dce8><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">Roman Kotov&#39;s blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/about.html" class="nav-link" aria-label="About"><!--[--><!--]--> About <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Articles"><span class="title">Articles</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Articles"><span class="title">Articles</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/articles/elixir-timeline.html" class="nav-link" aria-label="My Elixir timeline"><!--[--><!--]--> My Elixir timeline <!--[--><!--]--></a></li><li class="dropdown-item"><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="Elixir module registry via Protocols"><!--[--><!--]--> Elixir module registry via Protocols <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/articles/hello-world.html" class="nav-link" aria-label="Hello, World"><!--[--><!--]--> Hello, World <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a href="/credits.html" class="nav-link" aria-label="Credits"><!--[--><!--]--> Credits <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/privacy.html" class="nav-link" aria-label="Privacy"><!--[--><!--]--> Privacy <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/about.html" class="nav-link" aria-label="About"><!--[--><!--]--> About <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Articles"><span class="title">Articles</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Articles"><span class="title">Articles</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/articles/elixir-timeline.html" class="nav-link" aria-label="My Elixir timeline"><!--[--><!--]--> My Elixir timeline <!--[--><!--]--></a></li><li class="dropdown-item"><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="Elixir module registry via Protocols"><!--[--><!--]--> Elixir module registry via Protocols <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/articles/hello-world.html" class="nav-link" aria-label="Hello, World"><!--[--><!--]--> Hello, World <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a href="/credits.html" class="nav-link" aria-label="Credits"><!--[--><!--]--> Credits <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/privacy.html" class="nav-link" aria-label="Privacy"><!--[--><!--]--> Privacy <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">Elixir module registry via Protocols</p><ul class=""><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#where-this-can-help" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Where this can help"><!--[--><!--]--> Where this can help <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#model-serialization-deserialization" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Model serialization/deserialization"><!--[--><!--]--> Model serialization/deserialization <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#tagged-modules" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Tagged modules"><!--[--><!--]--> Tagged modules <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#implementation-challenges" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Implementation challenges"><!--[--><!--]--> Implementation challenges <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#empty-protocol" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Empty protocol"><!--[--><!--]--> Empty protocol <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#consolidation-and-dev-mode" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Consolidation and dev mode"><!--[--><!--]--> Consolidation and dev mode <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#persisting-attributes" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Persisting attributes"><!--[--><!--]--> Persisting attributes <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#defimpl-for-structure-and-for-atom" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Defimpl for structure and for atom"><!--[--><!--]--> Defimpl for structure and for atom <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#infinite-loop-with-for" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Infinite loop with @for"><!--[--><!--]--> Infinite loop with @for <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#overriding-implementations" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Overriding implementations"><!--[--><!--]--> Overriding implementations <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#alternative-implementations" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Alternative implementations"><!--[--><!--]--> Alternative implementations <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#map" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Map"><!--[--><!--]--> Map <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#enumerating-modules" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Enumerating modules"><!--[--><!--]--> Enumerating modules <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#runtime-cache" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Runtime cache"><!--[--><!--]--> Runtime cache <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#compile-time-module-workarounds" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Compile-time module workarounds"><!--[--><!--]--> Compile-time module workarounds <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/articles/elixir-module-registry-via-protocols.html#conclusion" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Conclusion"><!--[--><!--]--> Conclusion <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page" data-v-50d8dce8><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="elixir-module-registry-via-protocols" tabindex="-1"><a class="header-anchor" href="#elixir-module-registry-via-protocols" aria-hidden="true">#</a> Elixir module registry via Protocols</h1><p>The core idea of this article is that elixir protocols have a very interesting <a href="https://hexdocs.pm/elixir/1.12/Protocol.html#module-reflection" target="_blank" rel="noopener noreferrer">reflection feature<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>:</p><div class="language-elixir ext-elixir"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#E5C07B;">SomeProtocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__protocol__</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">impls</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"></span></code></pre></div><p>It can return the following results:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">not_consolidated</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># Or</span></span>
<span class="line"><span style="color:#ABB2BF;">{</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">consolidated</span><span style="color:#ABB2BF;">, implementations}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This method lists available implementations when the Protocol is consolidated.</p><h2 id="where-this-can-help" tabindex="-1"><a class="header-anchor" href="#where-this-can-help" aria-hidden="true">#</a> Where this can help</h2><p>This feature can be useful when you need to create a registry for modules. Let&#39;s consider a couple of examples:</p><h3 id="model-serialization-deserialization" tabindex="-1"><a class="header-anchor" href="#model-serialization-deserialization" aria-hidden="true">#</a> Model serialization/deserialization</h3><p>I was creating a <a href="https://mopidy.com" target="_blank" rel="noopener noreferrer">mopidy<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> API wrapper in elixir to play a music in our office. I did not find a websocket implementation for it, so decided to create a simple one by myself.</p><p>I needed to convert JSON-RPC models to elixir structs and back.</p><p>I was thinking about a way to register available models. A conversion may be implemented with a simple map like:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#ABB2BF;">%{</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#98C379;">&quot;model_1&quot;</span><span style="color:#ABB2BF;"> =&gt; </span><span style="color:#E5C07B;">Module1</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#98C379;">&quot;model_2&quot;</span><span style="color:#ABB2BF;"> =&gt; </span><span style="color:#E5C07B;">Module2</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>I decided to search for extra solutions according to these criteria:</p><ul><li>People usually forget to update explicit mappings. Model registration should be automated.</li><li>I should be able to extend models with extra functions.</li><li>Model definition should be brief and easy to understand.</li><li>I would like to store one model per file.</li><li>It would be nice to have all the models at compile time.</li><li>Easy to write seialization/deserialization for extra formats.</li></ul><p>Initial solution did not match all these criteria, but it was good enough. You can find it later in this article.</p><p>After some time a similar task appeared. I reviewed a previous solution and decided to research a little bit more, and liked the result better. Here is a simplified example of the core ideas:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defprotocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">name</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) :: </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">name</span><span style="color:#ABB2BF;">(data)</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Model</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">alias</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ModelProtocol</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defmacro</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">__using__</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> name, </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> fields) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">quote</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E5C07B;">Module</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">register_attribute</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">__MODULE__</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">model_name</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">persist:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">true</span></span>
<span class="line"><span style="color:#ABB2BF;">      )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E06C75;">@model_name</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(name)</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">defstruct</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(fields)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">name</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(name)</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;">, for: </span><span style="color:#E5C07B;">Atom</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">name</span><span style="color:#ABB2BF;">(module) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attributes</span></span>
<span class="line"><span style="color:#ABB2BF;">      |&gt; </span><span style="color:#61AFEF;">module</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__info__</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">      |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">model_name</span><span style="color:#ABB2BF;">, [])</span></span>
<span class="line"><span style="color:#ABB2BF;">      |&gt; </span><span style="color:#E5C07B;">List</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">first</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">registered_models</span><span style="color:#ABB2BF;">() </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    models </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">case</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__protocol__</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">impls</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        {</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">consolidated</span><span style="color:#ABB2BF;">, modules} -&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">          modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;"> -&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">extract_impls</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#56B6C2;">:code</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lib_dir</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">          )</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> model &lt;- models,</span></span>
<span class="line"><span style="color:#ABB2BF;">        model.</span><span style="color:#61AFEF;">__info__</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attributes</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">has_key?</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">model_name</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">into:</span><span style="color:#ABB2BF;"> %{},</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> {</span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">name</span><span style="color:#ABB2BF;">(model), model}</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(%{</span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> name, </span><span style="color:#D19A66;">params:</span><span style="color:#ABB2BF;"> params}) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">registered_models</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    |&gt; </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">fetch!</span><span style="color:#ABB2BF;">(name)</span></span>
<span class="line"><span style="color:#ABB2BF;">    |&gt; </span><span style="color:#61AFEF;">struct!</span><span style="color:#ABB2BF;">(params)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">serialize</span><span style="color:#ABB2BF;">(data) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    %{</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelProtocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">name</span><span style="color:#ABB2BF;">(data),</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">params:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">from_struct</span><span style="color:#ABB2BF;">(data)</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Sample1</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Model</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&quot;sample1&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">field1</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">field2</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Sample2</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ModelExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Model</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&quot;sample2&quot;</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">number_field:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">binary_field:</span><span style="color:#ABB2BF;"> </span><span style="color:#98C379;">&quot;example&quot;</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; ModelExample.Model.serialize(%ModelExample.Sample1{field1: 1, field2: 2})</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># %{name: &quot;sample1&quot;, params: %{field1: 1, field2: 2}}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; ModelExample.Model.deserialize(%{name: &quot;sample1&quot;, params: %{field1: 1, field2: 2}})</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># %ModelExample.Sample1{field1: 1, field2: 2}</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h3 id="tagged-modules" tabindex="-1"><a class="header-anchor" href="#tagged-modules" aria-hidden="true">#</a> Tagged modules</h3><p>When I was searching for a solution of model serialization task, I tried to solve it through tagging modules. You can also implement tagging with module registry, like this:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defprotocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">tags</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) :: [</span><span style="color:#61AFEF;">atom</span><span style="color:#ABB2BF;">()]</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">tags</span><span style="color:#ABB2BF;">(data)</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Tag</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">alias</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Tagged</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defmacro</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">__using__</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_opts</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">quote</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#E5C07B;">Module</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">register_attribute</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E5C07B;">__MODULE__</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">persist:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">true</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">accumulate:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">true</span></span>
<span class="line"><span style="color:#ABB2BF;">      )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">tags</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attributes</span></span>
<span class="line"><span style="color:#ABB2BF;">          |&gt; </span><span style="color:#E06C75;">@for</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__info__</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">          |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag</span><span style="color:#ABB2BF;">, [])</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;">, for: </span><span style="color:#E5C07B;">Atom</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">tags</span><span style="color:#ABB2BF;">(module) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attributes</span></span>
<span class="line"><span style="color:#ABB2BF;">      |&gt; </span><span style="color:#61AFEF;">module</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__info__</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">      |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag</span><span style="color:#ABB2BF;">, [])</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">tagged_modules</span><span style="color:#ABB2BF;">() :: [</span><span style="color:#61AFEF;">module</span><span style="color:#ABB2BF;">()]</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">tagged_modules</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    modules </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">case</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__protocol__</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">impls</span><span style="color:#ABB2BF;">) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        {</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">consolidated</span><span style="color:#ABB2BF;">, modules} -&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">          modules</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;"> -&gt;</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">extract_impls</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">            </span><span style="color:#56B6C2;">:code</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">lib_dir</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">          )</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> module &lt;- modules,</span></span>
<span class="line"><span style="color:#ABB2BF;">        module.</span><span style="color:#61AFEF;">__info__</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attributes</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">has_key?</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag</span><span style="color:#ABB2BF;">),</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> module</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">modules_with_tag</span><span style="color:#ABB2BF;">(tag :: </span><span style="color:#61AFEF;">atom</span><span style="color:#ABB2BF;">()) :: [</span><span style="color:#61AFEF;">module</span><span style="color:#ABB2BF;">()]</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">modules_with_tag</span><span style="color:#ABB2BF;">(tag) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> module &lt;- </span><span style="color:#61AFEF;">tagged_modules</span><span style="color:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#ABB2BF;">        module</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">tags</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Enum</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">member?</span><span style="color:#ABB2BF;">(tag),</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> module</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">TaggedModule1</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Tag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@tag</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag1</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@tag</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag2</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">TaggedModule2</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">use</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">TagExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Tag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@tag</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag2</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@tag</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag3</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; TagExample.Tag.tagged_modules()</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># [TagExample.TaggedModule2, TagExample.TaggedModule1]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; TagExample.Tag.modules_with_tag(:tag2)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># [TagExample.TaggedModule2]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; TagExample.Tag.modules_with_tag(:nonexisting_tag)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># []</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><h2 id="implementation-challenges" tabindex="-1"><a class="header-anchor" href="#implementation-challenges" aria-hidden="true">#</a> Implementation challenges</h2><p>I have learnt some new things while working on these examples. Let&#39;s look at them:</p><h3 id="empty-protocol" tabindex="-1"><a class="header-anchor" href="#empty-protocol" aria-hidden="true">#</a> Empty protocol</h3><p>It turns out that you can create an empty protocol, and even implement it, but it will lead to a compile-time warning:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defprotocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">EmptyProtocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">EmptyProtocol</span><span style="color:#ABB2BF;">, for: </span><span style="color:#E5C07B;">Atom</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># warning: module EmptyProtocol is not a behaviour (in module EmptyProtocol.Atom)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#  lib/empty_protocol.ex:4: EmptyProtocol.Atom (module)</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>I would recommend to add some functions to the protocol, but empty one will be enough if you want to use it as a registry.</p><h3 id="consolidation-and-dev-mode" tabindex="-1"><a class="header-anchor" href="#consolidation-and-dev-mode" aria-hidden="true">#</a> Consolidation and dev mode</h3><p><code>SomeProtocol.__protocol__(:impls)</code> worked fine on my PC while I was creating simple scripts. It&#39;s return value always was <code>{:consolidated, implementations}</code>. It began to return <code>:not_consolidated</code> after I started to integrate it with Phoenix. I was able to consolidate protocol in development mode by running <code>recompile</code> from <code>iex</code> session.</p><p>Every file change turned the protocol back to <code>:not_consolidated</code>, so I had to trigger recompilation manually every time.</p><p>After some research I started to use <a href="https://hexdocs.pm/elixir/1.12/Protocol.html" target="_blank" rel="noopener noreferrer">Protocol.extract_impls/2<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> for not consolidated protocol. This solution is much less performant, because it has to scan all module paths.</p><p>There is a tweak to reduce a number of <a href="https://github.com/elixir-lang/elixir/blob/a64d42f5d3cb6c32752af9d3312897e8cd5bb7ec/lib/mix/lib/mix/tasks/compile.protocols.ex#L111" target="_blank" rel="noopener noreferrer">consolidation paths<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>, but it will not help to match the performance of consolidated variant. It just skips standard library paths.</p><p>I would recommend using a consolidated version in production and <code>Protocol.extract_impls/2</code> in development.</p><h3 id="persisting-attributes" tabindex="-1"><a class="header-anchor" href="#persisting-attributes" aria-hidden="true">#</a> Persisting attributes</h3><p>Both example solutions persisted their values in module attributes. These attributes will be erased after compilation, and their values will be inlined into the code. If you need to access them from the outside of the module, you can persist them with:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#E5C07B;">Module</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">register_attribute</span><span style="color:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E5C07B;">__MODULE__</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attribute_name</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#D19A66;">persist:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">true</span></span>
<span class="line"><span style="color:#ABB2BF;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Persisting module attributes may be enough for demo purposes, but it is better to pick another approach for production systems, like creating a module function or adopting some behaviour. <a href="http://erlang.org/doc/reference_manual/modules.html#module_info-1" target="_blank" rel="noopener noreferrer">Module attributes docs<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> state that they may become empty.</p><blockquote><p>The list of attributes becomes empty if the module is stripped with the beam_lib(3) module (in STDLIB).</p></blockquote><p>It is better to use them with caution in production.</p><h3 id="defimpl-for-structure-and-for-atom" tabindex="-1"><a class="header-anchor" href="#defimpl-for-structure-and-for-atom" aria-hidden="true">#</a> <code>Defimpl</code> for structure and for atom</h3><p>I have also learnt one interesting and slightly confusing thing for elixir protocols. For example:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defprotocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">DefimplExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) :: </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(data)</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">DefimplExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">ModuleImplementation</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">DefimplExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">DefimplExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">StructImplementation</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defstruct</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">some_attribute</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">DefimplExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; DefimplExample.Protocol.some_method(DefimplExample.ModuleImplementation)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ** (Protocol.UndefinedError) protocol DefimplExample.Protocol not implemented for DefimplExample.ModuleImplementation of type Atom. This protocol is implemented for the following type(s): DefimplExample.StructImplementation, DefimplExample.ModuleImplementation</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#     lib/defimpl_example.ex:1: DefimplExample.Protocol.impl_for!/1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#     lib/defimpl_example.ex:3: DefimplExample.Protocol.some_method/1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; DefimplExample.Protocol.some_method(DefimplExample.StructImplementation)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ** (Protocol.UndefinedError) protocol DefimplExample.Protocol not implemented for DefimplExample.StructImplementation of type Atom. This protocol is implemented for the following type(s): DefimplExample.StructImplementation, DefimplExample.ModuleImplementation</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#     lib/defimpl_example.ex:1: DefimplExample.Protocol.impl_for!/1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#     lib/defimpl_example.ex:3: DefimplExample.Protocol.some_method/1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; DefimplExample.Protocol.some_method(%DefimplExample.ModuleImplementation{})</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ** (CompileError) iex:1: DefimplExample.ModuleImplementation.__struct__/1 is undefined, cannot expand struct DefimplExample.ModuleImplementation. Make sure the struct name is correct. If the struct name exists and is correct but it still cannot be found, you likely have cyclic module usage in your code</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#    (stdlib 3.13) lists.erl:1354: :lists.mapfoldl/3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; DefimplExample.Protocol.some_method(%DefimplExample.StructImplementation{})</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># :ok</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>Let&#39;s consider calling protocol for these cases:</p><ul><li><strong>Module name</strong>. It is an atom by nature, so protocol will search an implementation for Atom. If you don&#39;t have one, you will get an error.</li><li><strong>Structure</strong>. If you implement a protocol for a structure (<code>DefimplExample.StructImplementation</code>), you will be able to call it only like <code>%DefimplExample.StructImplementation{}</code>. Calling a protocol with module name will also result in error.</li></ul><p>I would recommend creating a separate implementation for <code>Atom</code> if you plan to support plain modules without structures, as well as structure modules by themselves. In other case you may end up with unreachable code, or use protocol only for tagging purposes.</p><h3 id="infinite-loop-with-for" tabindex="-1"><a class="header-anchor" href="#infinite-loop-with-for" aria-hidden="true">#</a> Infinite loop with <code>@for</code></h3><p>Another observation is related to the <code>@for</code>. <a href="https://hexdocs.pm/elixir/1.12/Protocol.html#module-multiple-implementations" target="_blank" rel="noopener noreferrer">According to the documentation<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>:</p><blockquote><p>Inside defimpl/3, you can use @protocol to access the protocol being implemented and @for to access the module it is being defined for.</p></blockquote><p>Let&#39;s consider an example:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defprotocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ForExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) :: </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(data)</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ForExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;">, for: </span><span style="color:#E5C07B;">Atom</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ForExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Implementation</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defstruct</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attribute</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ForExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">@for</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; ForExample.Protocol.some_method(ForExample.Implementation)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># :ok</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; ForExample.Protocol.some_method(%ForExample.Implementation{})</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># infinite loop</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>@for</code> here points to the <code>ForExample.Implementation</code> module. Module name is an atom, so, calling a function with it should call an implementation for Atom. But actually it calls not the protocol implementation, but the function itself. This leads to infinite tail-recursive loop in our example.</p><p>To actually call a protocol, you can do something like this:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ForExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Implementation</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defstruct</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attribute</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">ForExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#7F848E;font-style:italic;">_</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#E06C75;">@protocol</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">@for</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; ForExample.Protocol.some_method(%ForExample.Implementation{})</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># :ok</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="overriding-implementations" tabindex="-1"><a class="header-anchor" href="#overriding-implementations" aria-hidden="true">#</a> Overriding implementations</h3><p>It turned out that if you try to define defimpl multiple times for the same module, the last one will overwrite previous ones, and also show a warning about it.</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defprotocol</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">OverrideExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#E06C75;">@spec</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) :: </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(data)</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">OverrideExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;">, for: </span><span style="color:#E5C07B;">Atom</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">original</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">OverrideExample</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Protocol</span><span style="color:#ABB2BF;">, for: </span><span style="color:#E5C07B;">Atom</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">some_method</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">override</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># warning: redefining module OverrideExample.Protocol.Atom (current version loaded from _build/dev/lib/test/ebin/Elixir.OverrideExample.Protocol.Atom.beam)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#  lib/override_example.ex:10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; OverrideExample.Protocol.some_method(:override)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># :ok</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># iex&gt; OverrideExample.Protocol.some_method(:original)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;"># ** (FunctionClauseError) no function clause matching in OverrideExample.Protocol.Atom.some_method/1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#    The following arguments were given to OverrideExample.Protocol.Atom.some_method/1:</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#       # 1</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#       :original</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#    Attempted function clauses (showing 1 out of 1):</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#        def some_method(:override)</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic;">#    lib/override_example.ex:11: OverrideExample.Protocol.Atom.some_method/1</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>I would recommend to implement a protocol only once per data type. This should protect you from future surprises.</p><h2 id="alternative-implementations" tabindex="-1"><a class="header-anchor" href="#alternative-implementations" aria-hidden="true">#</a> Alternative implementations</h2><p>You can also implement a module registry with other approaches:</p><h3 id="map" tabindex="-1"><a class="header-anchor" href="#map" aria-hidden="true">#</a> Map</h3><p>The most simple solution. The only issue with it, that you, or other maintainer should remember to keep this map up to date.</p><h3 id="enumerating-modules" tabindex="-1"><a class="header-anchor" href="#enumerating-modules" aria-hidden="true">#</a> Enumerating modules</h3><p><a href="https://elixirforum.com/t/getting-a-list-of-tagged-modules/3804/11" target="_blank" rel="noopener noreferrer">Module enumeration<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> was one of the first things I have found.</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Tagged</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list_tagged_modules</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    {</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">ok</span><span style="color:#ABB2BF;">, modules} </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> </span><span style="color:#56B6C2;">:application</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get_key</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Application</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">get_application</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">__MODULE__</span><span style="color:#ABB2BF;">), </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">modules</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E5C07B;">Enum</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">filter</span><span style="color:#ABB2BF;">(modules, </span><span style="color:#E06C75;">&amp;</span><span style="color:#ABB2BF;">is_tagged</span><span style="color:#56B6C2;">/</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defp</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">is_tagged</span><span style="color:#ABB2BF;">(mod) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">attributes</span></span>
<span class="line"><span style="color:#ABB2BF;">    |&gt; </span><span style="color:#61AFEF;">mod</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">__info__</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">has_key?</span><span style="color:#ABB2BF;">(</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">tag</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>It works fine, but requires listing and checking of every module, so is not very performant. Performance issue may be solved with:</p><h3 id="runtime-cache" tabindex="-1"><a class="header-anchor" href="#runtime-cache" aria-hidden="true">#</a> Runtime cache</h3><p>The idea here is to create a mapping in runtime, and to cache it with something like:</p><ul><li><a href="https://hexdocs.pm/elixir/1.12/Registry.html" target="_blank" rel="noopener noreferrer">Registry<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://elixir-lang.org/getting-started/mix-otp/ets.html" target="_blank" rel="noopener noreferrer">ETS<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> or <a href="https://erlang.org/doc/man/dets.html" target="_blank" rel="noopener noreferrer">DETS<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://erlang.org/doc/man/mnesia.html" target="_blank" rel="noopener noreferrer">mnesia<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://hexdocs.pm/elixir/1.12/GenServer.html" target="_blank" rel="noopener noreferrer">GenServer<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://hexdocs.pm/elixir/1.12/Agent.html" target="_blank" rel="noopener noreferrer">Agent<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></li><li><a href="https://hexdocs.pm/elixir/1.12/Application.html#get_env/3" target="_blank" rel="noopener noreferrer">Application get_env<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> or their runtime analogs. <a href="https://hexdocs.pm/elixir/master/library-guidelines.html#avoid-compile-time-application-configuration" target="_blank" rel="noopener noreferrer">This approach is not recommended for libraries<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</li><li>possibly some other similar approach.</li></ul><p>Cache will surely help with lookup performance, but can introduce cache invalidation issues and extra complexity.</p><h3 id="compile-time-module-workarounds" tabindex="-1"><a class="header-anchor" href="#compile-time-module-workarounds" aria-hidden="true">#</a> Compile-time module workarounds</h3><p>Here I have attached an initial solution for model serialization task.</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Generator</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defmacro</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(model_name, </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> fields) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    model_keys </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> fields |&gt; </span><span style="color:#E5C07B;">Keyword</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">keys</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">    model_name_str </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> model_name |&gt; </span><span style="color:#E5C07B;">Macro</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">to_string</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">quote</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> unquote(model_name) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">defstruct</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(model_keys)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#E06C75;">@type</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() :: %</span><span style="color:#E5C07B;">__MODULE__</span><span style="color:#ABB2BF;">{</span><span style="color:#61AFEF;">unquote_splicing</span><span style="color:#ABB2BF;">(fields)}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Jason</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Encoder</span><span style="color:#ABB2BF;">, for: __MODULE__ </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">encode</span><span style="color:#ABB2BF;">(data, opts) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">            data</span></span>
<span class="line"><span style="color:#ABB2BF;">            |&gt; </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">from_struct</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">            |&gt; </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">put</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;__model__&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(model_name_str))</span></span>
<span class="line"><span style="color:#ABB2BF;">            |&gt; </span><span style="color:#E5C07B;">Jason</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Encode</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(opts)</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(data </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> %{</span><span style="color:#98C379;">&quot;__model__&quot;</span><span style="color:#ABB2BF;"> =&gt; </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(model_name_str)}) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        model_data </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> key &lt;- </span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(model_keys) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">            {key, data[</span><span style="color:#98C379;">&quot;</span><span style="color:#C678DD;">#{</span><span style="color:#98C379;">key</span><span style="color:#C678DD;">}</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">] |&gt; </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">          </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">        </span><span style="color:#61AFEF;">struct</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(model_name), model_data)</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">import</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Generator</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">only:</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">defmodel:</span><span style="color:#ABB2BF;"> </span><span style="color:#D19A66;">2</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Ref</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">type:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Track</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">artists:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Artist</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()),</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">album:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Album</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">composers:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Artist</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()),</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">performers:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Artist</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()),</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">genre:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">track_no:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">disc_no:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">date:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">length:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">bitrate:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">comment:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">muzicbrainz_id:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">last_modified:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Album</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">artists:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Artist</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()),</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">num_tracks:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">num_discs:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">date:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">muzicbrainz_id:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Artist</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">shortname:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">muzicbrainz_id:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Playlist</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">tracks:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Track</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">last_modified:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">Image</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">width:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">height:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">TlTrack</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">tlid:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">integer</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">track:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Track</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#61AFEF;">defmodel</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">SearchResult</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#D19A66;">fields:</span><span style="color:#ABB2BF;"> [</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">tracks:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Track</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">artists:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Artist</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">albums:</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">list</span><span style="color:#ABB2BF;">(</span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Album</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">()) | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    ]</span></span>
<span class="line"><span style="color:#ABB2BF;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(result) when </span><span style="color:#61AFEF;">is_map</span><span style="color:#ABB2BF;">(result) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> {key, value} &lt;- result, </span><span style="color:#D19A66;">into:</span><span style="color:#ABB2BF;"> %{} </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      {key, </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(value)}</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(result) when </span><span style="color:#61AFEF;">is_list</span><span style="color:#ABB2BF;">(result), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> result |&gt; </span><span style="color:#E5C07B;">Enum</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">&amp;</span><span style="color:#ABB2BF;">deserialize</span><span style="color:#56B6C2;">/</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(result), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> result</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br></div></div><p>After the macroexpansion we will get something like this:</p><div class="language-elixir ext-elixir line-numbers-mode"><pre class="shiki" style="background-color:#282c34;"><code><span class="line"><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">MopidyWS</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Models</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Ref</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">defstruct</span><span style="color:#ABB2BF;"> [</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">name</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">type</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">uri</span><span style="color:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#E06C75;">@type</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() :: %</span><span style="color:#E5C07B;">__MODULE__</span><span style="color:#ABB2BF;">{</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">name:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">type:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span><span style="color:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#D19A66;">uri:</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">String</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">t</span><span style="color:#ABB2BF;">() | </span><span style="color:#D19A66;">nil</span></span>
<span class="line"><span style="color:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">defimpl</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Jason</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Encoder</span><span style="color:#ABB2BF;">, for: __MODULE__ </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">encode</span><span style="color:#ABB2BF;">(data, opts) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        data</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">from_struct</span><span style="color:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Map</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">put</span><span style="color:#ABB2BF;">(</span><span style="color:#98C379;">&quot;__model__&quot;</span><span style="color:#ABB2BF;">, </span><span style="color:#98C379;">&quot;Ref&quot;</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">        |&gt; </span><span style="color:#E5C07B;">Jason</span><span style="color:#ABB2BF;">.</span><span style="color:#E5C07B;">Encode</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(opts)</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(data </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> %{</span><span style="color:#98C379;">&quot;__model__&quot;</span><span style="color:#ABB2BF;"> =&gt; </span><span style="color:#98C379;">&quot;Ref&quot;</span><span style="color:#ABB2BF;">}) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    model_data </span><span style="color:#56B6C2;">=</span></span>
<span class="line"><span style="color:#ABB2BF;">      </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> key &lt;- [</span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">name</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">type</span><span style="color:#ABB2BF;">, </span><span style="color:#D19A66;">:</span><span style="color:#56B6C2;">uri</span><span style="color:#ABB2BF;">] </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">        {key, data[</span><span style="color:#98C379;">&quot;</span><span style="color:#C678DD;">#{</span><span style="color:#98C379;">key</span><span style="color:#C678DD;">}</span><span style="color:#98C379;">&quot;</span><span style="color:#ABB2BF;">] |&gt; </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">}</span></span>
<span class="line"><span style="color:#ABB2BF;">       </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#61AFEF;">struct</span><span style="color:#ABB2BF;">(</span><span style="color:#61AFEF;">unquote</span><span style="color:#ABB2BF;">(model_name), model_data)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">defmodule</span><span style="color:#ABB2BF;"> </span><span style="color:#E5C07B;">Track</span><span style="color:#ABB2BF;"> </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;"># autogenerated model code</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(data </span><span style="color:#56B6C2;">=</span><span style="color:#ABB2BF;"> %{</span><span style="color:#98C379;">&quot;__model__&quot;</span><span style="color:#ABB2BF;"> =&gt; </span><span style="color:#98C379;">&quot;Track&quot;</span><span style="color:#ABB2BF;">}) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#7F848E;font-style:italic;"># deserialization code for Track model</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#7F848E;font-style:italic;"># other models</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(result) when </span><span style="color:#61AFEF;">is_map</span><span style="color:#ABB2BF;">(result) </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">for</span><span style="color:#ABB2BF;"> {key, value} &lt;- result, </span><span style="color:#D19A66;">into:</span><span style="color:#ABB2BF;"> %{} </span><span style="color:#C678DD;">do</span></span>
<span class="line"><span style="color:#ABB2BF;">      {key, </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(value)}</span></span>
<span class="line"><span style="color:#ABB2BF;">    </span><span style="color:#C678DD;">end</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(result) when </span><span style="color:#61AFEF;">is_list</span><span style="color:#ABB2BF;">(result), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> result |&gt; </span><span style="color:#E5C07B;">Enum</span><span style="color:#ABB2BF;">.</span><span style="color:#61AFEF;">map</span><span style="color:#ABB2BF;">(</span><span style="color:#E06C75;">&amp;</span><span style="color:#ABB2BF;">deserialize</span><span style="color:#56B6C2;">/</span><span style="color:#D19A66;">1</span><span style="color:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#ABB2BF;">  </span><span style="color:#C678DD;">def</span><span style="color:#ABB2BF;"> </span><span style="color:#61AFEF;">deserialize</span><span style="color:#ABB2BF;">(result), </span><span style="color:#D19A66;">do:</span><span style="color:#ABB2BF;"> result</span></span>
<span class="line"><span style="color:#C678DD;">end</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>I see the following drawbacks with it:</p><ul><li>It creates multiple modules in the same file.</li><li>It relies on the order of macros evaluation, otherwise <code>deserialize</code> function will not work properly.</li><li>Any extra code in the model will require more metaprogramming.</li><li>If I will add any other function between calls of <code>defmodel</code>, it will show warnings. It does not show them yet, because allows to create modules between function heads.</li></ul><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion" aria-hidden="true">#</a> Conclusion</h2><p>This was a nice journey, where we have learnt how to use elixir protocol as a module registry, with some edge cases. We have also discussed ways to achieve similar results. Thanks for reading!</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">9/2/2022, 7:43:57 PM</span></div><!----></footer><!----><!--[--><!--[--><div class="giscus" lang="en" data-v-50d8dce8><iframe title="Comments" class="giscus-frame"></iframe></div><div class="my-footer" data-v-50d8dce8><ul class="social-media-list" data-v-50d8dce8><li data-v-50d8dce8><a rel="me" href="mailto:roman@romankotov.com" title="RomanKotov" data-v-50d8dce8><svg class="svg-icon grey" data-v-50d8dce8><use xlink:href="/assets/minima-social-icons.svg#email" data-v-50d8dce8></use></svg></a></li><li data-v-50d8dce8><a rel="me" href="https://github.com/RomanKotov" title="RomanKotov" data-v-50d8dce8><svg class="svg-icon grey" data-v-50d8dce8><use xlink:href="/assets/minima-social-icons.svg#github" data-v-50d8dce8></use></svg></a></li><li data-v-50d8dce8><a rel="me" href="https://stackoverflow.com/users/8013693" title="8013693" data-v-50d8dce8><svg class="svg-icon grey" data-v-50d8dce8><use xlink:href="/assets/minima-social-icons.svg#stackoverflow" data-v-50d8dce8></use></svg></a></li><li data-v-50d8dce8><a rel="me" href="https://www.linkedin.com/in/kotovr" title="kotovr" data-v-50d8dce8><svg class="svg-icon grey" data-v-50d8dce8><use xlink:href="/assets/minima-social-icons.svg#linkedin" data-v-50d8dce8></use></svg></a></li><li data-v-50d8dce8><a rel="me" href="https://twitter.com/kotovr" title="kotovr" data-v-50d8dce8><svg class="svg-icon grey" data-v-50d8dce8><use xlink:href="/assets/minima-social-icons.svg#twitter" data-v-50d8dce8></use></svg></a></li></ul><a rel="license" href="https://creativecommons.org/licenses/by/4.0/" data-v-50d8dce8><img alt="Creative Commons License" style="border-width:0;" src="https://i.creativecommons.org/l/by/4.0/80x15.png" data-v-50d8dce8></a></div><!--]--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.f80e3e6e.js" defer></script>
  </body>
</html>
